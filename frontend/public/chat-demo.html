<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Lobby Chat Demo</title>
		<style>
			:root {
				color-scheme: light dark;
			}
			body {
				font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
				margin: 40px auto;
				max-width: 560px;
				line-height: 1.4;
			}
			#messages {
				border: 1px solid #cbd5f5;
				height: 320px;
				overflow-y: auto;
				padding: 12px;
				margin-bottom: 12px;
				border-radius: 12px;
				background: rgba(0, 0, 0, 0.02);
			}
			#messages .msg {
				margin-bottom: 0.45rem;
				font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
				font-size: 0.9rem;
			}
			.chat-row {
				display: flex;
				gap: 8px;
			}
			.chat-row input[type="text"] {
				flex: 1;
				padding: 8px;
				border-radius: 8px;
				border: 1px solid #cbd5f5;
			}
			button {
				padding: 8px 16px;
				border-radius: 8px;
				border: 1px solid transparent;
				background-color: #2563eb;
				color: white;
				font-weight: 600;
				cursor: pointer;
			}
			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
			}
		</style>
	</head>
	<body>
		<h1>Lobby Chat Demo</h1>
		<p>
			This minimal page connects to <code>/api/user/ws</code>. It assumes you are already authenticated in
			another tab (same origin) so the session cookie is available.
		</p>
		<div id="status">Connectingâ€¦</div>
		<div id="messages"></div>
		<div class="chat-row">
			<input type="text" id="messageInput" placeholder="Type a message (broadcast)" autocomplete="off" />
			<button id="sendBtn" disabled>Send</button>
		</div>

		<script>
			const messages = document.getElementById("messages");
			const statusEl = document.getElementById("status");
			const input = document.getElementById("messageInput");
			const sendBtn = document.getElementById("sendBtn");

			const wsUrl = (() => {
				const base = window.location.origin.replace(/^http/, "ws");
				return `${base}/api/user/ws`;
			})();

			const ws = new WebSocket(wsUrl);

			function log(line, variant = "incoming") {
				const div = document.createElement("div");
				div.className = "msg";
				div.textContent = line;
				if (variant === "system") {
					div.style.opacity = 0.7;
					div.style.fontStyle = "italic";
				} else if (variant === "outgoing") {
					div.style.color = "#16a34a";
				}
				messages.appendChild(div);
				messages.scrollTop = messages.scrollHeight;
			}

			ws.addEventListener("open", () => {
				statusEl.textContent = "Connected";
				sendBtn.disabled = false;
			});

			ws.addEventListener("close", () => {
				statusEl.textContent = "Disconnected";
				sendBtn.disabled = true;
				log("[system] connection closed", "system");
			});

			ws.addEventListener("error", () => {
				statusEl.textContent = "Error";
				log("[system] websocket error", "system");
			});

			ws.addEventListener("message", (event) => {
				log(event.data, "incoming");
			});

			function sendMessage() {
				const text = input.value.trim();
				if (!text || ws.readyState !== WebSocket.OPEN) return;
				const payload = {
					type: "broadcast",
					body: text,
				};
				ws.send(JSON.stringify(payload));
				log(`You: ${text}`, "outgoing");
				input.value = "";
			}

			sendBtn.addEventListener("click", sendMessage);
			input.addEventListener("keydown", (ev) => {
				if (ev.key === "Enter") {
					ev.preventDefault();
					sendMessage();
				}
			});
		</script>
	</body>
</html>
